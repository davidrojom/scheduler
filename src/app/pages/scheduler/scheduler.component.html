<main class="flex flex-col overflow-x-auto h-dvh touch-pan-x">
  <nav
    class="h-[80px] flex flex-row justify-between items-center gap-3 w-full bg-gray-800 p-3 sticky top-0 left-0 z-50 shadow-lg mb-[16px]"
  >
    <div class="flex items-center gap-3">
      <button
        (click)="toggleMobileMenu()"
        class="fflex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-700 transition-all cursor-pointer text-white"
        data-umami-event="toggle-mobile-menu"
      >
        <i
          class="ph text-xl text-white"
          [class.ph-list]="!mobileMenuOpen"
          [class.ph-x]="mobileMenuOpen"
        ></i>
      </button>

      <button
        (click)="addColumn()"
        class="flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-all cursor-pointer shadow-sm text-white font-medium"
        data-umami-event="add-column"
      >
        <i class="ph ph-plus text-xl"></i>
        <span class="hidden md:block">Add Column</span>
      </button>
    </div>

    <div class="flex items-center gap-3">
      <sch-project-switcher></sch-project-switcher>

      <button
        (click)="openSettings()"
        class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-700 transition-all cursor-pointer text-white"
        title="Settings"
        data-umami-event="open-settings"
      >
        <i class="ph ph-gear text-xl"></i>
      </button>
    </div>
  </nav>

  @if (mobileMenuOpen) {
  <div
    class="fixed inset-0 bg-black bg-opacity-10 z-40"
    (click)="closeMobileMenu()"
  >
    <div
      class="fixed top-[76px] bg-gray-800 p-3 flex flex-col gap-2 shadow-lg max-w-md"
    >
      <button
        (click)="open(wipeConfirmation); closeMobileMenu()"
        class="flex flex-row gap-3 items-center px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 transition-all text-white font-medium shadow-sm"
        data-umami-event="open-wipe-confirmation"
      >
        <i class="ph ph-trash text-xl"></i>
        <span>Wipe Data</span>
      </button>
      <button
        (click)="exportAndDownload(); closeMobileMenu()"
        class="flex flex-row gap-3 items-center px-4 py-3 rounded-lg bg-green-600 hover:bg-green-700 transition-all text-white font-medium shadow-sm"
        data-umami-event="download-schedule"
      >
        <i class="ph ph-file-arrow-down text-xl"></i>
        <span>Download</span>
      </button>
      <button
        (click)="takeScreenshot(); closeMobileMenu()"
        class="flex flex-row gap-3 items-center px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 transition-all text-white font-medium shadow-sm"
        data-umami-event="take-screenshot"
      >
        <i class="ph ph-projector-screen text-xl"></i>
        <span>Screenshot</span>
      </button>
      <button
        (click)="updateExportHash(); open(exportModal); closeMobileMenu()"
        class="flex flex-row gap-3 items-center px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 transition-all text-white font-medium shadow-sm"
        data-umami-event="open-share-modal"
      >
        <i class="ph ph-share-network text-xl"></i>
        <span>Share</span>
      </button>
      <button
        (click)="open(importModal); closeMobileMenu()"
        class="flex flex-row gap-3 items-center px-4 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 transition-all text-white font-medium shadow-sm"
        data-umami-event="open-import-modal"
      >
        <i class="ph ph-download-simple text-xl"></i>
        <span>Import</span>
      </button>
      <button
        (click)="openParticipantStats(); closeMobileMenu()"
        class="flex flex-row gap-3 items-center px-4 py-3 rounded-lg bg-purple-600 hover:bg-purple-700 transition-all text-white font-medium shadow-sm"
        data-umami-event="open-participants"
      >
        <i class="ph ph-users text-xl"></i>
        <span>Participants</span>
      </button>
    </div>
  </div>
  }
  <div class="mx-3 overflow-x-auto h-full">
    <div
      cdkDropList
      cdkDropListOrientation="horizontal"
      (cdkDropListDropped)="drop($event)"
      #dropList="cdkDropList"
      class="touch-pan-x"
    >
      <form id="schedule" [formGroup]="form" class="flex flex-row gap-4 w-fit">
        @for (column of form.controls.columns.controls; track
        column.controls.id; let i = $index) {
        <div
          #columnContainer
          class="flex flex-col divide-y w-[500px] min-w-[500px] select-none"
          cdkDrag
          [cdkDragStartDelay]="{
            touch: 200,
            mouse: 0
          }"
          [cdkDragLockAxis]="'x'"
          formArrayName="columns"
          (cdkDragStarted)="columnDragStarted(columnContainer)"
          (cdkDragEnded)="columnDragEnded(columnContainer)"
        >
          <header
            class="text-center bg-blue-500 rounded-t-md py-2 font-bold text-xl cursor-grabbing text-white flex flex-row gap-2 items-center justify-between px-4 sticky-column-header"
            cdkDragHandle
            [formGroupName]="i"
          >
            <button
              class="grid place-items-center w-[32px] h-[32px] rounded-full cursor-pointer hover:bg-blue-400 transition-all"
              (click)="open(deleteColumnConfirmation)"
              data-umami-event="open-delete-column-confirmation"
            >
              <i class="ph ph-trash"></i>
            </button>
            <input
              type="text"
              formControlName="title"
              class="p-2 bg-blue-900 text-center border rounded-md w-[400px]"
            />
          </header>
          <sch-schedule
            [columnId]="column.controls.id.value"
            (mousedown)="$event.stopPropagation()"
          />
        </div>
        <ng-template #deleteColumnConfirmation let-modal>
          <div class="modal-header">
            <h4 class="modal-title" id="modal-delete-title">Delete Column</h4>
            <button
              type="button"
              class="btn-close"
              aria-label="Close"
              (click)="modal.dismiss()"
            ></button>
          </div>
          <div class="modal-body">
            Do you really want to remove '<b class="font-bold">{{
              column.controls.title.value
            }}</b
            >' column?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="removeColumn(column.controls.id.value); modal.close()"
              data-umami-event="delete-column-confirm"
            >
              Yes
            </button>
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="modal.dismiss()"
            >
              No
            </button>
          </div>
        </ng-template>
        } @empty {
        <p class="text-gray-500 text-center">
          No columns yet. Click "Add Column" to create one.
        </p>
        }
      </form>
    </div>
  </div>
</main>

<ng-template #wipeConfirmation let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-wipe-title">Wipe Data</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss()"
    ></button>
  </div>
  <div class="modal-body">Do you really want to wipe all the data?</div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="wipeData(); modal.close()"
      data-umami-event="wipe-data-confirm"
    >
      Yes
    </button>
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="modal.dismiss()"
    >
      No
    </button>
  </div>
</ng-template>

<ng-template #exportModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-export-title">Share</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss()"
    ></button>
  </div>
  <div class="modal-body">
    <button
      class="flex flex-row items-center gap-2 mx-auto text-white bg-blue-600 rounded-md px-4 py-2"
      (click)="copyToClipboard(); modal.dismiss()"
      data-umami-event="copy-share-hash"
    >
      <i class="ph ph-copy-simple text-xl"></i>
      <span>Copy hash to clipboard</span>
    </button>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="modal.dismiss()"
    >
      Close
    </button>
  </div>
</ng-template>

<ng-template #importModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-import-title">Import</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss()"
    ></button>
  </div>
  <div class="modal-body flex flex-col gap-2">
    <span>Import schedule</span>
    <input
      type="text"
      class="border rounded-md px-2 py-1"
      #importField
      placeholder="Enter import hash"
    />
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="import(importField.value); modal.close()"
      data-umami-event="import-schedule"
    >
      Import
    </button>
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="modal.dismiss()"
    >
      Cancel
    </button>
  </div>
</ng-template>
